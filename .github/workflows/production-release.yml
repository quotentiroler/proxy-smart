name: Production Release

on:
  push:
    branches: [main]
    paths-ignore:
      - "ui/src/lib/api-client/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: releases
  cancel-in-progress: false

jobs:
  check-changes:
    name: Check if release is needed
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changed files
        id: check
        run: |
          # Get list of changed files in the last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Define documentation-only patterns
          DOC_PATTERNS="README\.md|\.md$|docs/|LICENSE|CHANGELOG"

          # Check if only documentation files were changed
          NON_DOC_CHANGES=$(echo "$CHANGED_FILES" | grep -vE "$DOC_PATTERNS" || true)

          if [ -z "$NON_DOC_CHANGES" ]; then
            echo "Only documentation files changed, skipping production release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "Code changes detected, proceeding with production release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

  # Production releases run full security and compliance testing
  production-testing:
    name: Production Testing (Security & Compliance)
    needs: check-changes
    if: ${{ needs.check-changes.outputs.should_release == 'true' && !contains(github.event.head_commit.message, 'ðŸ”„ Update version') && !contains(github.event.head_commit.message, 'ðŸ¤– Update API clients') && !contains(github.event.head_commit.message, 'Production release') && !contains(github.event.head_commit.message, 'ðŸŽ‰') }}
    uses: ./.github/workflows/testing-strategy.yml
    with:
      test_stage: "production"
      test_scope: "all"

  production-release:
    name: Production Release
    needs: [check-changes, production-testing]
    # Only run if the last commit is not a release commit AND there are non-documentation changes
    if: ${{ needs.check-changes.outputs.should_release == 'true' && !contains(github.event.head_commit.message, 'ðŸ”„ Update version') && !contains(github.event.head_commit.message, 'ðŸ¤– Update API clients') && !contains(github.event.head_commit.message, 'Production release') && !contains(github.event.head_commit.message, 'ðŸŽ‰') }}
    uses: ./.github/workflows/release-orchestrator.yml
    with:
      release_type: "RELEASE"
      source_branch: "main"
      target_branch: "main"
      should_bump_version: false
      is_prerelease: false
      commit_limit: 20
    secrets:
      APP_ID: ${{ secrets.APP_ID }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  # Revert changes if production release fails
  revert-on-failure:
    name: Revert Changes on Failure
    runs-on: ubuntu-latest
    needs: [production-release]
    if: ${{ failure() && needs.production-release.result == 'failure' }}

    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token }}

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Revert to previous commit
        run: |
          echo "ðŸš¨ Production release failed - reverting main branch to previous commit"

          # Reset to the previous commit (HEAD~1)
          git reset --hard HEAD~1

          # Force push the revert
          git push origin main --force

          echo "âœ… Successfully reverted main branch to previous commit"

          # Create an issue to track the failed release
          gh issue create \
            --title "ðŸš¨ Production Release Failed - Main Branch Reverted" \
            --body "**Production release pipeline failed and main branch has been automatically reverted.**

          **Details:**
          - Reverted to previous commit (HEAD~1)
          - Failed workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Timestamp: $(date -u)

          **Next Steps:**
          1. Investigate the release failure in the workflow logs
          2. Fix any issues that caused the release to fail
          3. Re-run the production release when ready" \
            --label "bug,release-failure,high-priority"
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
