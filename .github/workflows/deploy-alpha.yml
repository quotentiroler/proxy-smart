name: Deploy Alpha

on:
  workflow_call:
    inputs:
      app_version:
        description: 'Version of the application to deploy'
        required: true
        type: string
      source_branch:
        description: 'Source branch for deployment'
        required: true
        type: string
    outputs:
      fhir_server_url:
        description: "FHIR server URL after deployment"
        value: ${{ jobs.deploy.outputs.fhir_server_url }}
      keycloak_url:
        description: "Keycloak URL after deployment"
        value: ${{ jobs.deploy.outputs.keycloak_url }}
      app_url:
        description: "Main application URL after deployment"
        value: ${{ jobs.deploy.outputs.app_url }}
      deployment_status:
        description: "Status of the deployment"
        value: ${{ jobs.deploy.outputs.deployment_status }}
      deployment_target:
        description: "Target platform where app was deployed"
        value: ${{ jobs.deploy.outputs.deployment_target }}
    secrets:
      NORTHFLANK_API_TOKEN:
        required: true
      NORTHFLANK_PROJECT_ID:
        required: true
      NORTHFLANK_SERVICE_ID_FULLSTACK:
        required: true
      NORTHFLANK_SERVICE_ID_KEYCLOAK:
        required: true

jobs:
  deploy:
    name: Deploy Alpha (Northflank)
    runs-on: ubuntu-latest
    outputs:
      fhir_server_url: ${{ steps.deploy.outputs.fhir_server_url }}
      keycloak_url: ${{ steps.deploy.outputs.keycloak_url }}
      app_url: ${{ steps.deploy.outputs.app_url }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}
      deployment_target: ${{ steps.deploy.outputs.deployment_target }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
      
      - name: Check Keycloak Changes
        id: check-keycloak-changes
        run: |
          echo "ğŸ” Checking if Keycloak realm configuration has changed..."
          
          # Check if realm export file has changed in this commit
          REALM_CHANGED=$(git diff HEAD~1 HEAD --name-only | grep -E "keycloak/.*\.json$|Dockerfile\.keycloak$" || true)
          
          if [ -n "$REALM_CHANGED" ]; then
            echo "ğŸ“ Keycloak configuration files changed:"
            echo "$REALM_CHANGED"
            echo "keycloak_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Keycloak deployment required"
          else
            echo "keycloak_changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No Keycloak changes detected - skipping Keycloak deployment"
          fi

      - name: Deploy Alpha Keycloak (Northflank)
        id: deploy-keycloak
        if: steps.check-keycloak-changes.outputs.keycloak_changed == 'true'
        env:
          NORTHFLANK_API_TOKEN: ${{ secrets.NORTHFLANK_API_TOKEN }}
          NORTHFLANK_PROJECT_ID: ${{ secrets.NORTHFLANK_PROJECT_ID }}
          NORTHFLANK_SERVICE_ID: ${{ secrets.NORTHFLANK_SERVICE_ID_KEYCLOAK }}
        run: |
          echo "ğŸ” Deploying Keycloak for Alpha environment (configuration changed)..."
          
          # Trigger Northflank deployment via API (combined service)
          echo "ğŸš€ Triggering Keycloak deployment on Northflank..."
          DEPLOY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/services/${NORTHFLANK_SERVICE_ID}/build" \
            -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"type": "code"}')
          
          HTTP_CODE=$(echo "$DEPLOY_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$DEPLOY_RESPONSE" | sed '/HTTP_CODE:/d')
          
          BUILD_ID=$(echo "$RESPONSE_BODY" | jq -r '.data.buildId // empty')
          
          if [ -z "$BUILD_ID" ] || [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Failed to trigger Keycloak deployment (HTTP $HTTP_CODE)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          echo "âœ… Keycloak build triggered (Build ID: $BUILD_ID)"
          
          # Wait for build and deployment to complete
          echo "â³ Waiting for Keycloak build to complete..."
          MAX_WAIT=300  # 5 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            BUILD_INFO=$(curl -s \
              "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/builds/${BUILD_ID}" \
              -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}")
            
            BUILD_STATUS=$(echo "$BUILD_INFO" | jq -r '.data.status // "unknown"')
            
            if [ "$BUILD_STATUS" = "success" ]; then
              echo "âœ… Keycloak build completed successfully!"
              
              # Check service deployment status
              SERVICE_INFO=$(curl -s \
                "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/services/${NORTHFLANK_SERVICE_ID}" \
                -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}")
              
              DEPLOY_STATUS=$(echo "$SERVICE_INFO" | jq -r '.data.deployment.status // "unknown"')
              
              if [ "$DEPLOY_STATUS" = "running" ] || [ "$DEPLOY_STATUS" = "healthy" ]; then
                echo "âœ… Keycloak service is live and healthy!"
                break
              else
                echo "ğŸ”„ Service status: $DEPLOY_STATUS (waiting for healthy state...)"
              fi
            elif [ "$BUILD_STATUS" = "failed" ]; then
              echo "âŒ Keycloak build failed"
              echo "Build info: $BUILD_INFO"
              exit 1
            elif [ "$BUILD_STATUS" = "building" ] || [ "$BUILD_STATUS" = "pending" ]; then
              echo "ğŸ”„ Build status: $BUILD_STATUS (${ELAPSED}s elapsed)"
            else
              echo "âš ï¸ Unexpected build status: $BUILD_STATUS (${ELAPSED}s elapsed)"
            fi
            
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âš ï¸ Deployment timeout - check Northflank dashboard"
          fi
          
          echo "âœ… Keycloak deployed and available"
          echo "âœ… Realm 'proxy-smart' imported and available"

      - name: Skip Keycloak Deployment
        if: steps.check-keycloak-changes.outputs.keycloak_changed == 'false'
        run: |
          echo "â­ï¸ Skipping Keycloak deployment - no configuration changes detected"
          echo "ğŸ” Existing Keycloak instance will be used"
      
      - name: Deploy Alpha Fullstack (Northflank)
        id: deploy
        env:
          NORTHFLANK_API_TOKEN: ${{ secrets.NORTHFLANK_API_TOKEN }}
          NORTHFLANK_PROJECT_ID: ${{ secrets.NORTHFLANK_PROJECT_ID }}
          NORTHFLANK_SERVICE_ID: ${{ secrets.NORTHFLANK_SERVICE_ID_FULLSTACK }}
        run: |
          echo "ğŸš€ Deploying Alpha version ${{ inputs.app_version }} to Northflank..."

          # Trigger Northflank deployment via API (combined service)
          echo "ğŸš€ Triggering fullstack deployment on Northflank..."
          DEPLOY_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/services/${NORTHFLANK_SERVICE_ID}/build" \
            -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"type": "code"}')
          
          HTTP_CODE=$(echo "$DEPLOY_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$DEPLOY_RESPONSE" | sed '/HTTP_CODE:/d')
          
          BUILD_ID=$(echo "$RESPONSE_BODY" | jq -r '.data.buildId // empty')
          
          if [ -z "$BUILD_ID" ] || [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Failed to trigger fullstack deployment (HTTP $HTTP_CODE)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          echo "âœ… Fullstack build triggered (Build ID: $BUILD_ID)"
          
          # Wait for build and deployment to complete
          echo "â³ Waiting for fullstack build to complete..."
          MAX_WAIT=600  # 10 minutes for fullstack
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            BUILD_INFO=$(curl -s \
              "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/builds/${BUILD_ID}" \
              -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}")
            
            BUILD_STATUS=$(echo "$BUILD_INFO" | jq -r '.data.status // "unknown"')
            
            if [ "$BUILD_STATUS" = "success" ]; then
              echo "âœ… Fullstack build completed successfully!"
              
              # Check service deployment status
              SERVICE_INFO=$(curl -s \
                "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/services/${NORTHFLANK_SERVICE_ID}" \
                -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}")
              
              DEPLOY_STATUS=$(echo "$SERVICE_INFO" | jq -r '.data.deployment.status // "unknown"')
              
              if [ "$DEPLOY_STATUS" = "running" ] || [ "$DEPLOY_STATUS" = "healthy" ]; then
                echo "âœ… Fullstack service is live and healthy!"
                break
              else
                echo "ğŸ”„ Service status: $DEPLOY_STATUS (waiting for healthy state...)"
              fi
            elif [ "$BUILD_STATUS" = "failed" ]; then
              echo "âŒ Fullstack build failed"
              echo "Build info: $BUILD_INFO"
              exit 1
            elif [ "$BUILD_STATUS" = "building" ] || [ "$BUILD_STATUS" = "pending" ]; then
              echo "ğŸ”„ Build status: $BUILD_STATUS (${ELAPSED}s elapsed)"
            else
              echo "âš ï¸ Unexpected build status: $BUILD_STATUS (${ELAPSED}s elapsed)"
            fi
            
            sleep 15
            ELAPSED=$((ELAPSED + 15))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âš ï¸ Deployment timeout - check Northflank dashboard"
            exit 1
          fi

          # Get service details to extract URLs
          echo "ğŸ“¡ Fetching service details..."
          SERVICE_INFO=$(curl -s \
            "https://api.northflank.com/v1/projects/${NORTHFLANK_PROJECT_ID}/services/${NORTHFLANK_SERVICE_ID}" \
            -H "Authorization: Bearer ${NORTHFLANK_API_TOKEN}")
          
          # Extract the public URL from the service (mono service on port 8445)
          FULLSTACK_URL=$(echo "$SERVICE_INFO" | jq -r '.data.publicUrl // empty')
          
          if [ -z "$FULLSTACK_URL" ]; then
            echo "âš ï¸ Could not extract fullstack URL from service info"
            FULLSTACK_URL="https://proxy-smart-alpha--${NORTHFLANK_PROJECT_ID}.code.run"
          fi
          
          # Construct Keycloak URL (assuming naming convention)
          KEYCLOAK_URL="https://keycloak-alpha--${NORTHFLANK_PROJECT_ID}.code.run"
          
          # Set outputs
          # Mono service serves both backend API and UI at /webapp
          echo "fhir_server_url=${FULLSTACK_URL}/proxy-smart-backend/hapi-fhir-server/R4" >> $GITHUB_OUTPUT
          echo "keycloak_url=$KEYCLOAK_URL" >> $GITHUB_OUTPUT
          echo "app_url=${FULLSTACK_URL}/webapp" >> $GITHUB_OUTPUT
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "deployment_target=northflank" >> $GITHUB_OUTPUT
          
          echo "âœ… Alpha deployment completed successfully"
          echo "ğŸ“ Fullstack Service: $FULLSTACK_URL"
          echo "ğŸ“ UI (Web App): ${FULLSTACK_URL}/webapp"
          echo "ğŸ“ Backend API: $FULLSTACK_URL"
          echo "ğŸ“ FHIR Server (Proxied): ${FULLSTACK_URL}/proxy-smart-backend/hapi-fhir-server/R4"
          echo "ğŸ“ Keycloak: $KEYCLOAK_URL"
          echo "ğŸ“ Keycloak Admin: $KEYCLOAK_URL (admin/admin)"
          echo "ğŸ“ SMART Realm: $KEYCLOAK_URL/realms/proxy-smart"
          echo "ğŸ“ OIDC Discovery: $KEYCLOAK_URL/realms/proxy-smart/.well-known/openid_configuration"
          
          # Log deployment efficiency information
          if [ "${{ steps.check-keycloak-changes.outputs.keycloak_changed }}" = "true" ]; then
            echo "ğŸ”„ Keycloak was redeployed due to configuration changes"
          else
            echo "âš¡ Deployment optimized - reused existing Keycloak instance"
          fi
