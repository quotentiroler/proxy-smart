name: SMART Compliance Tests (Inferno)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smart_stu2_2'
        type: choice
        options:
          - smart_stu2_2
          - smart_stu2
          - smart_stu1
  # Run on releases
  push:
    tags:
      - 'v*'
  # Scheduled weekly run
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC

env:
  INFERNO_VERSION: main
  TEST_SUITE: ${{ inputs.test_suite || 'smart_stu2_2' }}

jobs:
  smart-compliance-test:
    name: SMART ${{ inputs.test_suite || 'STU2.2' }} Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: keycloak
          POSTGRES_PASSWORD: keycloak
          POSTGRES_DB: keycloak
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: ./.github/actions/setup-bun-version

      - name: Install dependencies
        run: bun install

      - name: Build Backend
        run: |
          cd backend
          bun run build

      # Start Keycloak
      - name: Start Keycloak
        run: |
          docker run -d \
            --name keycloak \
            --network host \
            -e KEYCLOAK_ADMIN=admin \
            -e KEYCLOAK_ADMIN_PASSWORD=admin \
            -e KC_DB=postgres \
            -e KC_DB_URL=jdbc:postgresql://localhost:5432/keycloak \
            -e KC_DB_USERNAME=keycloak \
            -e KC_DB_PASSWORD=keycloak \
            -e KC_HEALTH_ENABLED=true \
            -e KC_HTTP_ENABLED=true \
            -e KC_HOSTNAME_STRICT=false \
            quay.io/keycloak/keycloak:26.0.5 \
            start-dev --import-realm
          
          # Wait for Keycloak to be ready
          echo "Waiting for Keycloak..."
          for i in {1..60}; do
            if curl -sf http://localhost:8080/health/ready; then
              echo "Keycloak is ready"
              break
            fi
            sleep 5
          done

      # Start the application
      - name: Start Application
        run: |
          cd backend
          bun run start &
          
          # Wait for app to be ready
          echo "Waiting for application..."
          for i in {1..30}; do
            if curl -sf http://localhost:8445/health; then
              echo "Application is ready"
              break
            fi
            sleep 2
          done
        env:
          NODE_ENV: production
          KEYCLOAK_URL: http://localhost:8080

      # Clone and setup Inferno
      - name: Setup Inferno Test Kit
        run: |
          git clone https://github.com/inferno-framework/smart-app-launch-test-kit.git inferno
          cd inferno
          
          # Create docker-compose for Inferno
          cat > docker-compose.ci.yml << 'EOF'
          version: '3.8'
          services:
            inferno:
              build: .
              ports:
                - "4567:4567"
              environment:
                - REDIS_URL=redis://redis:6379
                - DATABASE_URL=postgresql://inferno:inferno@inferno-db:5432/inferno
              depends_on:
                inferno-db:
                  condition: service_healthy
                redis:
                  condition: service_started
            
            inferno-db:
              image: postgres:16-alpine
              environment:
                POSTGRES_USER: inferno
                POSTGRES_PASSWORD: inferno
                POSTGRES_DB: inferno
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U inferno"]
                interval: 5s
                timeout: 5s
                retries: 5
            
            redis:
              image: redis:7-alpine
          EOF

      - name: Start Inferno
        run: |
          cd inferno
          docker compose -f docker-compose.ci.yml up -d --build
          
          # Wait for Inferno to be ready
          echo "Waiting for Inferno..."
          for i in {1..60}; do
            if curl -sf http://localhost:4567; then
              echo "Inferno is ready"
              break
            fi
            sleep 5
          done

      # Register test client in Keycloak
      - name: Register Inferno Client
        run: |
          # Get admin token
          TOKEN=$(curl -s -X POST "http://localhost:8080/realms/master/protocol/openid-connect/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            -d "username=admin" \
            -d "password=admin" | jq -r '.access_token')
          
          # Create client
          curl -s -X POST "http://localhost:8080/admin/realms/proxy-smart/clients" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "clientId": "inferno-test-client",
              "enabled": true,
              "publicClient": true,
              "standardFlowEnabled": true,
              "directAccessGrantsEnabled": true,
              "redirectUris": [
                "http://localhost:4567/custom/smart_stu2_2/redirect",
                "http://localhost:4567/custom/smart_stu2/redirect",
                "http://localhost:4567/*"
              ],
              "webOrigins": ["http://localhost:4567"],
              "attributes": {
                "pkce.code.challenge.method": "S256"
              }
            }'

      # Run Inferno tests
      - name: Run SMART Compliance Tests
        id: inferno-tests
        run: |
          # Create test session
          SESSION=$(curl -s -X POST "http://localhost:4567/api/test_sessions" \
            -H "Content-Type: application/json" \
            -d "{\"test_suite_id\": \"$TEST_SUITE\"}" | jq -r '.id')
          
          echo "Created test session: $SESSION"
          echo "session_id=$SESSION" >> $GITHUB_OUTPUT
          
          # Get test suite info
          SUITE_INFO=$(curl -s "http://localhost:4567/api/test_suites/$TEST_SUITE")
          FIRST_GROUP=$(echo $SUITE_INFO | jq -r '.test_groups[0].id')
          
          # Run tests with inputs
          RUN=$(curl -s -X POST "http://localhost:4567/api/test_runs" \
            -H "Content-Type: application/json" \
            -d "{
              \"test_session_id\": \"$SESSION\",
              \"test_group_id\": \"$FIRST_GROUP\",
              \"inputs\": [
                {\"name\": \"url\", \"value\": \"http://localhost:8445/fhir\"},
                {\"name\": \"smart_authorization_url\", \"value\": \"http://localhost:8080/realms/proxy-smart/protocol/openid-connect/auth\"},
                {\"name\": \"smart_token_url\", \"value\": \"http://localhost:8080/realms/proxy-smart/protocol/openid-connect/token\"},
                {\"name\": \"client_id\", \"value\": \"inferno-test-client\"}
              ]
            }" | jq -r '.id')
          
          echo "Started test run: $RUN"
          echo "run_id=$RUN" >> $GITHUB_OUTPUT
          
          # Poll for completion (max 10 minutes)
          for i in {1..120}; do
            STATUS=$(curl -s "http://localhost:4567/api/test_runs/$RUN" | jq -r '.status')
            echo "Test status: $STATUS"
            
            if [ "$STATUS" = "done" ]; then
              break
            fi
            
            sleep 5
          done
          
          # Get results
          RESULTS=$(curl -s "http://localhost:4567/api/test_runs/$RUN/results")
          
          PASSED=$(echo $RESULTS | jq '[.[] | select(.result == "pass")] | length')
          FAILED=$(echo $RESULTS | jq '[.[] | select(.result == "fail")] | length')
          SKIPPED=$(echo $RESULTS | jq '[.[] | select(.result == "skip")] | length')
          ERRORS=$(echo $RESULTS | jq '[.[] | select(.result == "error")] | length')
          
          echo "## SMART Compliance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** $TEST_SUITE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ✅ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| ❌ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ⏭️ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "| ⚠️ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          
          # Fail if there are failures or errors
          if [ "$FAILED" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
            echo "::error::SMART compliance tests failed: $FAILED failures, $ERRORS errors"
            
            # List failed tests
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo $RESULTS | jq -r '.[] | select(.result == "fail" or .result == "error") | "- \(.test_id): \(.result)"' >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi

      # Upload test results
      - name: Upload Test Results
        if: always()
        run: |
          mkdir -p test-results
          
          SESSION="${{ steps.inferno-tests.outputs.session_id }}"
          RUN="${{ steps.inferno-tests.outputs.run_id }}"
          
          if [ -n "$RUN" ]; then
            curl -s "http://localhost:4567/api/test_runs/$RUN/results" > test-results/inferno-results.json
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inferno-test-results
          path: test-results/
          retention-days: 30

      # Cleanup
      - name: Cleanup
        if: always()
        run: |
          cd inferno || true
          docker compose -f docker-compose.ci.yml down -v || true
          docker stop keycloak || true
          docker rm keycloak || true
