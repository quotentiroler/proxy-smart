name: Testing Strategy

on:
  workflow_call:
    inputs:
      test_stage:
        description: "Testing stage: alpha, beta, or production"
        required: true
        type: string
      deployment_target:
        description: "Where the application is deployed: local, northflank, or vps"
        required: false
        type: string
        default: "local"
      fhir_server_url:
        description: "FHIR server URL for testing (provided by deployment workflow)"
        required: false
        type: string
        default: "http://localhost:3001"
      keycloak_url:
        description: "Keycloak URL for testing (provided by deployment workflow)"
        required: false
        type: string
        default: "http://localhost:8080"
      app_version:
        description: "Version of the application being tested"
        required: false
        type: string
        default: "dev"

    outputs:
      test_status:
        description: "Overall test status"
        value: ${{ jobs.test-summary.outputs.overall_status }}
      test_reports_path:
        description: "Path to test reports"
        value: ${{ jobs.test-summary.outputs.reports_path }}
      compliance_passed:
        description: "Number of compliance tests passed"
        value: ${{ jobs.smart-compliance-tests.outputs.passed }}
      compliance_failed:
        description: "Number of compliance tests failed"
        value: ${{ jobs.smart-compliance-tests.outputs.failed }}

    secrets:
      DISCORD_WEBHOOK_URL:
        description: "Discord webhook URL for notifications"
        required: false

jobs:
  # Run SMART on FHIR 2.2.0 compliance tests via dedicated workflow
  smart-compliance-tests:
    name: SMART 2.2.0 Compliance (${{ inputs.test_stage }})
    uses: ./.github/workflows/smart-compliance-tests.yml
    with:
      test_suite: 'smart_stu2_2'
      test_stage: ${{ inputs.test_stage }}
    secrets: inherit

  # Integration tests against deployed services (runs in parallel)
  integration-tests:
    name: Integration Tests (${{ inputs.test_stage }})
    runs-on: ubuntu-latest
    
    outputs:
      status: ${{ steps.tests.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "üöÄ Setting up integration testing environment..."
          echo "Test Stage: ${{ inputs.test_stage }}"
          echo "Deployment Target: ${{ inputs.deployment_target }}"
          echo "FHIR Server: ${{ inputs.fhir_server_url }}"
          echo "Keycloak: ${{ inputs.keycloak_url }}"
          
          # Create test directory structure
          mkdir -p testing/${{ inputs.test_stage }}/reports/{integration,summary}

      - name: Wait for deployment readiness
        run: |
          echo "‚è≥ Waiting for deployment to be ready..."
          max_attempts=30
          attempt=1
          
          # Extract base URL from FHIR server URL (remove the /proxy-smart-backend/... path)
          BASE_URL=$(echo "${{ inputs.fhir_server_url }}" | sed 's|/proxy-smart-backend.*||')
          echo "Checking health at: $BASE_URL/health"
          
          while [ $attempt -le $max_attempts ]; do
            if curl -sf "$BASE_URL/health" >/dev/null 2>&1; then
              echo "‚úÖ Deployed server is ready and responding"
              break
            fi
            echo "üîÑ Waiting for server... (attempt $attempt/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "‚ö†Ô∏è Deployed server not responding - integration tests may be skipped"
          fi

      - name: Run integration tests against deployed services
        id: tests
        run: |
          echo "üîó Running integration tests against deployed ${{ inputs.test_stage }} environment..."
          
          # Extract base URL from FHIR server URL
          BASE_URL=$(echo "${{ inputs.fhir_server_url }}" | sed 's|/proxy-smart-backend.*||')
          echo "Base server URL: $BASE_URL"
          echo "FHIR endpoint URL: ${{ inputs.fhir_server_url }}"
          
          TESTS_PASSED=0
          TESTS_TOTAL=0
          
          # Test basic health endpoint
          echo ""
          echo "Testing health endpoint..."
          TESTS_TOTAL=$((TESTS_TOTAL + 1))
          if curl -sf "$BASE_URL/health" > testing/${{ inputs.test_stage }}/reports/integration/health.json 2>&1; then
            echo "‚úÖ Health endpoint working"
            TESTS_PASSED=$((TESTS_PASSED + 1))
          else
            echo "‚ö†Ô∏è Health endpoint not available"
          fi
          
          # Test FHIR server metadata endpoint
          echo ""
          echo "Testing FHIR metadata endpoint..."
          TESTS_TOTAL=$((TESTS_TOTAL + 1))
          if curl -sf "${{ inputs.fhir_server_url }}/metadata" > testing/${{ inputs.test_stage }}/reports/integration/fhir_metadata.json 2>&1; then
            echo "‚úÖ FHIR metadata endpoint working"
            TESTS_PASSED=$((TESTS_PASSED + 1))
          else
            echo "‚ö†Ô∏è FHIR metadata endpoint not available"
          fi
          
          # Test OAuth discovery
          echo ""
          echo "Testing OAuth discovery endpoint..."
          TESTS_TOTAL=$((TESTS_TOTAL + 1))
          if curl -sf "${{ inputs.keycloak_url }}/realms/proxy-smart/.well-known/openid-configuration" > testing/${{ inputs.test_stage }}/reports/integration/oauth_discovery.json 2>&1; then
            echo "‚úÖ OAuth discovery endpoint working"
            TESTS_PASSED=$((TESTS_PASSED + 1))
          else
            echo "‚ö†Ô∏è OAuth discovery endpoint not available"
          fi
          
          # Test SMART configuration
          echo ""
          echo "Testing SMART configuration endpoint..."
          TESTS_TOTAL=$((TESTS_TOTAL + 1))
          SMART_CONFIG_URL="${{ inputs.fhir_server_url }}/.well-known/smart-configuration"
          if curl -sf "$SMART_CONFIG_URL" > testing/${{ inputs.test_stage }}/reports/integration/smart_config.json 2>&1; then
            echo "‚úÖ SMART configuration endpoint working"
            TESTS_PASSED=$((TESTS_PASSED + 1))
            
            # Validate key SMART config fields
            if jq -e '.authorization_endpoint' testing/${{ inputs.test_stage }}/reports/integration/smart_config.json >/dev/null 2>&1; then
              echo "  ‚úì authorization_endpoint present"
            fi
            if jq -e '.token_endpoint' testing/${{ inputs.test_stage }}/reports/integration/smart_config.json >/dev/null 2>&1; then
              echo "  ‚úì token_endpoint present"
            fi
          else
            echo "‚ö†Ô∏è SMART configuration endpoint not available"
          fi
          
          echo ""
          echo "=== Integration Test Summary ==="
          echo "Passed: $TESTS_PASSED / $TESTS_TOTAL"
          
          if [ $TESTS_PASSED -eq $TESTS_TOTAL ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          elif [ $TESTS_PASSED -gt 0 ]; then
            echo "status=partial" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          
          echo "{\"passed\": $TESTS_PASSED, \"total\": $TESTS_TOTAL}" > testing/${{ inputs.test_stage }}/reports/integration/summary.json

      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ inputs.test_stage }}
          path: testing/${{ inputs.test_stage }}/reports/integration/
          retention-days: 30

  # Summarize all test results
  test-summary:
    name: Test Summary (${{ inputs.test_stage }})
    runs-on: ubuntu-latest
    needs: [smart-compliance-tests, integration-tests]
    if: always()
    
    outputs:
      overall_status: ${{ steps.summary.outputs.overall_status }}
      reports_path: ${{ steps.summary.outputs.reports_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate test summary
        id: summary
        run: |
          echo "üìä Generating test summary..."
          mkdir -p testing/${{ inputs.test_stage }}/reports/summary
          
          # Get test results
          COMPLIANCE_STATUS="${{ needs.smart-compliance-tests.outputs.status || 'failure' }}"
          COMPLIANCE_PASSED="${{ needs.smart-compliance-tests.outputs.passed || '0' }}"
          COMPLIANCE_FAILED="${{ needs.smart-compliance-tests.outputs.failed || '0' }}"
          INTEGRATION_STATUS="${{ needs.integration-tests.outputs.status || 'failed' }}"
          
          echo "SMART Compliance: $COMPLIANCE_STATUS (passed: $COMPLIANCE_PASSED, failed: $COMPLIANCE_FAILED)"
          echo "Integration Tests: $INTEGRATION_STATUS"
          
          # Determine overall status
          if [[ "$COMPLIANCE_STATUS" == "success" && "$INTEGRATION_STATUS" == "passed" ]]; then
            OVERALL_STATUS="passed"
            STATUS_EMOJI="‚úÖ"
          elif [[ "$COMPLIANCE_STATUS" == "success" || "$INTEGRATION_STATUS" == "passed" ]]; then
            OVERALL_STATUS="partial"
            STATUS_EMOJI="‚ö†Ô∏è"
          else
            OVERALL_STATUS="failed"
            STATUS_EMOJI="‚ùå"
          fi
          
          echo "Overall Status: $OVERALL_STATUS"
          echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
          echo "reports_path=testing/${{ inputs.test_stage }}/reports" >> $GITHUB_OUTPUT
          
          # Generate summary report
          SUMMARY_FILE="testing/${{ inputs.test_stage }}/reports/summary/test_summary.md"
          
          cat > "$SUMMARY_FILE" << EOF
          # $STATUS_EMOJI Test Results - ${{ inputs.test_stage }}
          
          **Generated**: $(date -u)
          **Test Stage**: ${{ inputs.test_stage }}
          **Deployment Target**: ${{ inputs.deployment_target }}
          **App Version**: ${{ inputs.app_version }}
          **Overall Status**: $OVERALL_STATUS
          
          ## Test Environment
          - **FHIR Server**: ${{ inputs.fhir_server_url }}
          - **Keycloak**: ${{ inputs.keycloak_url }}
          - **Deployment**: ${{ inputs.deployment_target }}
          
          ## Test Results Summary
          | Test Type | Status | Details |
          |-----------|--------|---------|
          | SMART 2.2.0 Compliance | $COMPLIANCE_STATUS | Passed: $COMPLIANCE_PASSED, Failed: $COMPLIANCE_FAILED |
          | Integration Tests | $INTEGRATION_STATUS | Health, Metadata, OAuth, SMART Config |
          
          ## Overall Result: **$OVERALL_STATUS**
          EOF
          
          echo "‚úÖ Test summary generated"

      - name: Generate GitHub Step Summary
        run: |
          echo "## üß™ Test Results - ${{ inputs.test_stage }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Stage | ${{ inputs.test_stage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Target | ${{ inputs.deployment_target }} |" >> $GITHUB_STEP_SUMMARY
          echo "| App Version | ${{ inputs.app_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SMART 2.2.0 Compliance Tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.smart-compliance-tests.outputs.status || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed**: ${{ needs.smart-compliance-tests.outputs.passed || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: ${{ needs.smart-compliance-tests.outputs.failed || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.integration-tests.outputs.status || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Result" >> $GITHUB_STEP_SUMMARY
          echo "**${{ steps.summary.outputs.overall_status }}**" >> $GITHUB_STEP_SUMMARY

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-${{ inputs.test_stage }}
          path: testing/${{ inputs.test_stage }}/reports/summary/
          retention-days: 30

  # Discord notification on successful testing
  notify-testing-success:
    name: Discord Success Notification
    needs: [smart-compliance-tests, integration-tests, test-summary]
    if: ${{ always() && needs.test-summary.outputs.overall_status == 'passed' }}
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Send Discord testing success notification
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          notification-type: 'testing'
          title: '‚úÖ Tests Passed: ${{ inputs.test_stage }} v${{ inputs.app_version }}'
          description: |
            All tests passed for ${{ inputs.test_stage }} environment!
            SMART Compliance: ${{ needs.smart-compliance-tests.outputs.passed }} passed, ${{ needs.smart-compliance-tests.outputs.failed }} failed
          version: ${{ inputs.app_version }}
          deployment-stage: ${{ inputs.test_stage }}
          deployment-target: ${{ inputs.deployment_target }}
          fhir-server-url: ${{ inputs.fhir_server_url }}
          keycloak-url: ${{ inputs.keycloak_url }}
          repository: ${{ github.repository }}
          commit-sha: ${{ github.sha }}
          actor: ${{ github.actor }}
          color: '00FF00'

  # Discord notification on testing failure
  notify-testing-failure:
    name: Discord Failure Notification
    needs: [smart-compliance-tests, integration-tests, test-summary]
    if: ${{ always() && needs.test-summary.outputs.overall_status != 'passed' }}
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Send Discord testing failure notification
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        uses: ./.github/actions/discord-notify
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          notification-type: 'error'
          title: '‚ùå Tests Failed: ${{ inputs.test_stage }} v${{ inputs.app_version }}'
          description: |
            Some tests failed for ${{ inputs.test_stage }} environment.
            SMART Compliance: ${{ needs.smart-compliance-tests.outputs.passed }} passed, ${{ needs.smart-compliance-tests.outputs.failed }} failed
          version: ${{ inputs.app_version }}
          deployment-stage: ${{ inputs.test_stage }}
          deployment-target: ${{ inputs.deployment_target }}
          fhir-server-url: ${{ inputs.fhir_server_url }}
          keycloak-url: ${{ inputs.keycloak_url }}
          repository: ${{ github.repository }}
          commit-sha: ${{ github.sha }}
          actor: ${{ github.actor }}
          color: 'FF0000'
